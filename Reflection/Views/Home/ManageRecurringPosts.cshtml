@{
    Layout = "";
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" />
    <link href="~/CSS/ManageRecurringPosts.css" rel="stylesheet" type="text/css" />
    <title>Screen3</title>
</head>

<body>
    <div class="loader"></div>
    <input type="text" value=@ViewBag.emailid id="contextemail" style="display:none"/>
    <div class="container">
        <!-- Modal -->
        <div class="" role="document">
            <div class="">
                <div class="modal-mb-sc2">
                    @*<div class="recurring">Recurring posts</div>*@
                    @*<div class="recu-desc">
                            View and manage recurring posts below. Previous posts will not be affected
                            and any changes will automatically apply only
                            to future posts.
                        </div>*@
                    <table class="table custom-tb">
                        <thead>
                            <tr>
                                <th scope="col" class="qutin">Question<span id="questioncount"></span></th>
                                <th scope="col" class="privacy">Privacy</th>
                                <th scope="col" class="snd-post">Send post at</th>
                            </tr>
                        </thead>
                        <tbody id="tablebody">
                        </tbody>
                    </table>
                </div>
                <div class="mf">
                    <div class="float-left">
                        <span class="left-chev"></span>
                        Back
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" tabindex="-1" role="dialog" id="myalert">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h5>Are you sure to delete ?</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="deleteRecurssion()">Yes</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">NO</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="@("https://unpkg.com/@microsoft/teams-js@1.4.1/dist/MicrosoftTeams.min.js")"></script>
    <script>
        var deleteid = ""
        var blockdata = ""
        $(document).ready(function () {
            $(".loader").show();
            
            getRecurssions();
        });

       

        $('.delete-icon').click(function () {
            $('#myModal').modal('show');
        });

        function getRecurssions() {
            var email = $("#contextemail").val();
            $.ajax({
                type: 'GET',
                url: '/api/GetRecurssions/'+email,
                success: function (data) {
                    $(".loader").hide();
                    $(".custom-tb").show();
                    recurssions = JSON.parse(JSON.parse(data).recurssions);
                    $("#questioncount").html("(" + recurssions.length + ")");
                    daysInWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    var sendpostat = "";
                    blockdata = "";
                    recurssions.forEach(x => {
                        if (x.RecurssionType == "Monthly") {
                            sendpostat = "Every Month " + new Date(x.RefCreatedDate).getDate() + " at " + new Date(x.RefCreatedDate).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true, minute: 'numeric' });
                        }
                        else if (x.RecurssionType == "Weekly") {
                            sendpostat = "Every Week " + daysInWeek[new Date(x.RefCreatedDate).getDay()] + " at " + new Date(x.RefCreatedDate).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true, minute: 'numeric' });
                        }
                        else {
                            sendpostat = "Every Week Day"
                        }
                        blockdata = blockdata + '<tr id="row1"><td class="hw-r-u">' + x.Question + '<div class="hru-desc">Created by: ' + x.CreatedBy + ' on ' + new Date(x.RefCreatedDate).toDateString() + '</div></td><td>' + x.Privacy + '</td> <td class="date-day">' + sendpostat + '</td><td class="delete-icon" id="delete'+x.RefID+'" data-toggle="modal" data-target="#myalert"></td></tr>';
                    })
                    $("#tablebody").html(blockdata);
                    setTimeout(() => {
                        recurssions.forEach(x => {
                            $(document).on("click", "#delete" + x.RefID, function (event) {
                                deleteid = event.currentTarget.id.split('te')[1];
                            });
                        });
                  }, 100);
             
                }
            });
        }

        function deleteRecurssion() {
             $.ajax({
                type: 'GET',
                url: '/api/DeleteReflection/'+deleteid,
                success: function (data) {
                    if (data == "Deleted") {
                        $("#tablebody").html("");
                        getRecurssions();
                    }
             
                }
            });
        }

    </script>

</body>


</html>